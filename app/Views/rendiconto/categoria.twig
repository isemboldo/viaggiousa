{% extends "layout.twig" %}
{% block title %}Categoria: {{ label }}{% endblock %}

{% block content %}
<section class="rendiconto-page">
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 1rem;">
  <a href="{{ base_url }}/rendiconto" class="btn subtle">← Torna al rendiconto</a>
  <a class="btn subtle" href="{{ base_url }}/rendiconto/categoria/{{ label|lower|replace({' ':'-'}) }}.csv?locale=en">Esporta CSV</a>

  <button type="button" class="btn subtle" id="copy-link">Copia link</button>
</div>
  <h1 class="page-title">Categoria: {{ label }}</h1>

  {% if missing and missing|length > 0 %}
    <div class="callout warn">
      Tassi mancanti per: {{ missing|join(', ') }}.
    </div>
  {% endif %}

  {% if missing_rows and missing_rows|length > 0 %}
    <div class="callout warn" style="margin-bottom:1rem;">
      <strong>Da verificare ({{ label }}):</strong> voci senza tasso (prime 10).
      <table class="table" style="margin-top:.5rem;">
        <thead><tr>
          <th>Data</th><th>Descrizione</th><th>Valuta</th><th class="ta-r">Importo (orig.)</th><th>Giorno</th>
        </tr></thead>
        <tbody>
          {% for r in missing_rows|slice(0,10) %}
            <tr>
              <td>{{ r.data ?: '—' }}</td>
              <td>{{ r.descrizione }}</td>
              <td>{{ r.valuta }}</td>
              <td class="ta-r">{{ r.amount }}</td>
              <td>{% if r.giorno_id %}<a href="{{ base_url }}/giorno/{{ r.giorno_id }}">Giorno {{ r.giorno_id }}</a>{% else %}—{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if missing_rows|length > 10 %}
        <div class="note">…e altre {{ missing_rows|length - 10 }} voci.</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="cards-3">
    <div class="card">
      <div class="card-title">Totale</div>
      <div class="card-value">{{ total }}</div>
    </div>
  </div>

  <h2 class="sec-title">Voci</h2>
  <table class="table cat">
    <thead>
      <tr>
        <th>Data</th>
        <th>Descrizione</th>
        <th class="ta-r">Importo (orig.)</th>
        <th class="ta-r">CHF</th>
        <th>Giorno</th>
        <th>Pagato da</th>
        <th>Diviso per</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
        <tr>
          <td>{{ r.data ?: '—' }}</td>
          <td>{{ r.descrizione }}</td>
          <td class="ta-r">{{ r.amount }}</td>
          <td class="ta-r">{{ r.amount_chf }}</td>
          <td>
            {% if r.giorno_id %}
              <a href="{{ base_url }}/giorno/{{ r.giorno_id }}">Giorno {{ r.giorno_id }}</a>
            {% else %}—{% endif %}
          </td>
          <td>{{ r.pagato_da ?: '—' }}</td>
          <td>{{ r.diviso_per ?: '—' }}</td>
        </tr>
      {% else %}
        <tr><td colspan="7">Nessuna voce in questa categoria.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
<script>
(function(){
  const btn = document.getElementById('copy-link');
  if (!btn) return;
  btn.addEventListener('click', async ()=>{
    const url = window.location.href;
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(url);
      } else {
        const ta = document.createElement('textarea');
        ta.value = url; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      const old = btn.textContent; btn.textContent='Copiato ✓'; setTimeout(()=>btn.textContent=old,1500);
    } catch(e){ alert('Non riesco a copiare il link: '+e); }
  });
})();
</script>
{% endblock %}
